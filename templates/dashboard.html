{% extends "base.html" %}
<div class="container-fluid px-0">
    <h2 class="mb-4">Dashboard</h2>
    <div class="row g-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">Open Incidents</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for incident in open_incidents %}
                        <li class="list-group-item">{{ incident.title }} <span class="badge bg-warning text-dark ms-2">{{ incident.priority }}</span></li>
                        {% else %}
                        <li class="list-group-item">No open incidents</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">Current Shift Engineers</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for engineer in current_engineers %}
                        <li class="list-group-item">{{ engineer.name }}</li>
                        {% else %}
                        <li class="list-group-item">No current shift engineers</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">Next Shift Engineers</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for engineer in next_shift_engineers %}
                        <li class="list-group-item">{{ engineer.name }}</li>
                        {% else %}
                        <li class="list-group-item">No next shift engineers</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-secondary text-white">Open Key Points</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for kp in open_key_points %}
                        <li class="list-group-item">{{ kp.description }}</li>
                        {% else %}
                        <li class="list-group-item">No open key points</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
{% block content %}
<div class="container-fluid px-0">
    <h2 class="mb-4">Dashboard</h2>

    {% if accounts and teams %}
    <form method="get" class="row g-3 mb-4">
        <div class="col-auto">
            <label for="account_id" class="form-label">Account</label>
            <select class="form-select" id="account_id" name="account_id" onchange="this.form.submit()">
                {% for account in accounts %}
                    <option value="{{ account.id }}" {% if account.id == selected_account_id %}selected{% endif %}>{{ account.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <label for="team_id" class="form-label">Team</label>
            <select class="form-select" id="team_id" name="team_id" onchange="this.form.submit()">
                {% for team in teams %}
                    <option value="{{ team.id }}" {% if team.id == selected_team_id %}selected{% endif %}>{{ team.name }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
    {% endif %}

    <div class="row g-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">Open Incidents</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for incident in open_incidents %}
                        <li class="list-group-item">{{ incident.title }} <span class="badge bg-warning text-dark ms-2">{{ incident.priority }}</span></li>
                        {% else %}
                        <li class="list-group-item">No open incidents</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">Current Shift Engineers</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for engineer in current_engineers %}
                        <li class="list-group-item">{{ engineer.name }}</li>
                        {% else %}
                        <li class="list-group-item">No current shift engineers</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">Next Shift Engineers</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for engineer in next_shift_engineers %}
                        <li class="list-group-item">{{ engineer.name }}</li>
                        {% else %}
                        <li class="list-group-item">No next shift engineers</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-secondary text-white">Open Key Points</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for kp in open_key_points %}
                        <li class="list-group-item">{{ kp.description }}</li>
                        {% else %}
                        <li class="list-group-item">No open key points</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="mt-4">
    <h4>Overview Chart</h4>
    <form method="get" class="row g-2 align-items-end mb-3">
        <div class="col-auto">
            <label for="range" class="form-label">Date Range</label>
            <select name="range" id="range" class="form-control">
                <option value="1d" {% if selected_range == '1d' %}selected{% endif %}>Last 1 Day</option>
                <option value="7d" {% if selected_range == '7d' or not selected_range %}selected{% endif %}>Last 7 Days</option>
                <option value="30d" {% if selected_range == '30d' %}selected{% endif %}>Last 1 Month</option>
                <option value="1y" {% if selected_range == '1y' %}selected{% endif %}>Last 1 Year</option>
                <option value="custom" {% if selected_range == 'custom' %}selected{% endif %}>Custom</option>
            </select>
        </div>
        <div class="col-auto" id="custom-date-fields" {% if selected_range != 'custom' %}style="display:none;"{% endif %}>
            <label for="start_date" class="form-label">From</label>
            <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date }}">
            <label for="end_date" class="form-label">To</label>
            <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date }}">
        </div>
        <!-- Single date field removed -->
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Apply</button>
        </div>
    </form>
    <div id="chart"></div>
    <script>
        document.getElementById('range').addEventListener('change', function() {
            var customFields = document.getElementById('custom-date-fields');
            if (this.value === 'custom') {
                customFields.style.display = '';
            } else {
                customFields.style.display = 'none';
            }
        });
        var graphJSON = {{ graphJSON|safe }};
        if (typeof graphJSON === 'object') {
            Plotly.newPlot('chart', graphJSON.data, graphJSON.layout);
        } else {
            var parsed = graphJSON;
            if (typeof graphJSON === 'string') {
                parsed = JSON.parse(graphJSON);
            }
            Plotly.newPlot('chart', parsed.data, parsed.layout);
        }
    </script>
</div>
{% endblock %}
